<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ChatEasy</title>
		<link
			rel="stylesheet"
			href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
			integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
			crossorigin="anonymous"
		/>

        <style>
            html,
            body {
                height: 100%;
                width: 100%;
                height: 100vh;
                width: 100vw;
                margin: 0;
                background: green;
                display: flex;
                flex-direction: column;
            }

            #chat_window {
                /* background: lightblue; */
                overflow: scroll;
                height: 500px;
                border-bottom: 1px ridge rgba(128, 128, 128, 0.274);
                border-top: 1px ridge rgba(128, 128, 128, 0.274);
                margin-bottom: 10px;
                /* flex: 1; */
            }


            /* .header {
                height: 5%;
            } */

            #chat_window::-webkit-scrollbar {
                display: none
            }

            .speaker {
                color: blue;
                font-size: 15px
            }

            .text {
                color: black;
                font-size: 15px
            }

            .footer {
                flex: 1;
                display: flex;
            }

            .send-button {
                margin: 0 5px 0 5px;
            }
        </style>
	</head>
	<body>
		<div class="container">
        <div class="jumbotron header">
            <div>
                <label for="from">From</label>
                <input type="username" class="form-control" id="from_box" placeholder="---" disabled>
                <small id="usernameHelp" class="text-muted">This will appear to your reciever.</small>
            </div>
            <div>
                <button class="btn btn-primary" id="signout-button" style="margin: 10px">Sign Out</button>
            </div>
            <div>
                <label for="to">To</label>
                <input type="username" class="form-control" id="to_box" placeholder="Jennifer">
                <!-- <small id="usernameHelp" class="text-muted">This will appear with your messages.</small> -->
            </div>
            <div>
                <button class="btn btn-primary" id="load-button" style="margin: 10px">Load</button>
            </div>
        </div>

        <div class="jumbotron main-space">
            <div class="container" id="chat_window">
                <!-- <div class="message">
                    <span class="speaker">Chaitanya:</span>
                    <span class="text">Hello</span> -->
            </div>
            <div class="footer">
                <input class="form-control" id="message_box" placeholder="Type a message">
                <button class="btn btn-primary send-button" id="send-button" disabled>Send</button>
            </div>
        </div>
    </div>
    </div>


		<script src="/socket.io/socket.io.js"></script>
		<script>
            var socket = io();
			console.log("Hello World");

            socket.emit("naming");
            socket.on('naming',(name)=>{
                fromBox.value = name;
            })

            socket.on("message", function (data) {
				console.log(data);
                socket.emit("message","Okay!")
			});
            
			header = document.querySelector(".header");
            chats = document.querySelector("#chat_window");
            footer = document.querySelector(".footer");

            fromBox = document.querySelector("#from_box");
            toBox = document.querySelector("#to_box");
            signoutButton = document.querySelector("#signout-button");
            loadButton = document.querySelector("#load-button");

            messagebox = document.querySelector("#message_box");
            sendButton = document.querySelector("#send-button");

            chats.style.height = (window.innerHeight - header.offsetHeight - footer.offsetHeight - 150) + "px";

            var first = true;
            
            function deleteCookie(name){
                document.cookie = name+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            }
            
            function load() {
                from = fromBox.value;
                if (from === "") {
                    alert("Your username is required!");
                    return;
                }
                to = toBox.value;
                if (to === "") {
                    alert("Reciever username is required!");
                    return;
                }

                socket.emit("extractChatsBetn",[from,to]);
                chats.innerHTML = "";
            } 

            function getMessageHTML(username, message) {
                return "<div class=\"message\">  " +
                    "<span class = \"speaker\">" +
                    username +
                    ": </span> " +
                    "<span class = \"text\">" +
                    message +
                    "</span> " +
                    "</div>";
            }

            socket.on("newChatList", function (chatlist) {
                
                chatlist.forEach(chat => {
                    console.log(chat);
                    from = fromBox.value;
                    to = toBox.value;
                
                    if((chat['_FROM']===from && chat['_TO']===to)
                        || (chat['_FROM']===to && chat['_TO']===from))
                    {
                        HTML = getMessageHTML(chat['_FROM'], chat['_MESSAGE']);
                        chats.innerHTML += HTML;
                        allP = document.querySelectorAll(".text");
                        allP[allP.length - 1].scrollIntoView();
                    }
                });
                if(first){
                    sendButton.disabled = false;
                    messagebox.focus();
                    first = false;
                }
			});


            function send() {
                message = messagebox.value;
                if (message === "") 
                    return;

                console.log('sending message');

                socket.emit('newChat',{
                    _FROM:from,
                    _TO:to,
                    _MESSAGE:message,
                });
                messagebox.value = "";
            }

            signoutButton.addEventListener('click', ()=>{
                deleteCookie('session-id');window.location.replace("/chat");
            });
            loadButton.addEventListener('click', load);
            fromBox.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    load();
                }
            });
            toBox.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    load();
                }
            });
            sendButton.addEventListener('click', send);
            messagebox.addEventListener('keydown', function(event) {
                if (event.key === "Enter") {
                    send();
                }
            })

            document.addEventListener('DOMContentLoaded', function() {
                loadButton.disabled = false;
            });
		</script>
	</body>
</html>
